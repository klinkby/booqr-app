# Repository Overview for Agents

- **Framework**: SvelteKit with Svelte 5 in SPA mode, targeting static site deployments. Agents MUST prefer Svelte 5 features, specifically **runes** (`$state`, `$derived`, `$effect`, etc.) for reactivity and state management. For navigation, use `import { goto } from '$app/navigation'; goto(url);` instead of `window.location`.
- **Styling**: Tailwind CSS with the official `forms` plugin ensures a minimal but extendable design system.
- **Tooling**: Keeps dependencies lean by relying on native ES2022 features and avoiding TypeScript tooling.
- **Verification**: Playwright is installed for end-to-end verification of the UI when needed.

Agents should focus on small, composable changes that align with these constraints and avoid introducing unnecessary dependencies.

## Build and Publishing 
- Uses two-stage Docker builds to ensure repeatability and the final image is compact and secure.
- Static web server is lighttpd configured for security and minimal attack surface.
- Keep the build output split into vendor and non-vendor bundles while targeting ES2022 without introducing TypeScript.


- **Never** manually edit `src/lib/api/**` files as they are auto generated by the `import-api` npm script.
- The API is called using axios API

## API Client Configuration
- **Axios Setup**: Configured in `src/lib/axiosConfig.js` with interceptors for authentication
- **Initialization**: `configureApiClient()` is called in `src/routes/+layout.js` to set up interceptors on app start
- **Generated API Services**: Auto-generated services in `src/lib/api/services/` use the default axios instance with configured interceptors
- **OpenAPI Config**: `OpenAPI.TOKEN`, `OpenAPI.WITH_CREDENTIALS`, and `OpenAPI.CREDENTIALS` are configured for the generated API client
- **Security**: Duplicate interceptor registration prevented with `interceptorsConfigured` flag

## Authentication
- **JWT Bearer Access Tokens**: Sent in `Authorization: Bearer ${token}` header for API requests
- **Refresh Tokens**: Stored in httponly cookies, automatically sent by browser with `withCredentials: true`
- **Token Refresh Implementation**:
  - Uses `axios-auth-refresh` package to automatically refresh expired access tokens
  - Interceptor configured on default axios instance catches 401 responses
  - Calls `POST /api/auth/refresh` with httponly cookie to get new access token
  - Automatically retries failed request with new token
  - Queues simultaneous requests during refresh to prevent multiple refresh calls
- **Token Management**: Centralized in `src/lib/axiosConfig.js`. ONLY `setAccessToken()` and `clearAccessToken()` should be used to modify the token.
- **Auth Flow**:
  1. Request fails with 401 Unauthorized
  2. Interceptor calls `POST /api/auth/refresh` (with `skipAuthRefresh: true` to prevent infinite loop)
  3. If refresh succeeds: validate token format, store new token using `setAccessToken()`, update failed request headers, retry original request
  4. If refresh fails: clear token using `clearAccessToken()`, redirect to `/login`
- **Token Storage**: Access tokens stored in `sessionStorage.access_token`
- **Token Validation**: JWT tokens validated for basic structure (3 dot-separated parts) before storage/injection
- **Token Injection**: Request interceptor automatically adds `Authorization: Bearer ${token}` header to validated tokens only
- **Login**: Use `AuthenticationService.login()` with email/password, store `access_token` from response using `setAccessToken()`, clear password from memory. On page load, `/login` tries `AuthenticationService.refresh()` to auto-login if a valid refresh cookie exists.
- **Logout**: Call `AuthenticationService.logout()`, clear token using `clearAccessToken()`, redirect to home page
- **Auth State**: Check `sessionStorage.access_token` presence (via `getAccessToken()` and `isValidToken()`) to determine logged-in state in UI

## Security Considerations
- **Secrets Management**: **NEVER** store secrets, credentials, or API keys in code files. ALWAYS use `.env` file (gitignored) for sensitive data
- **Token Validation**: All tokens validated for JWT structure before use or storage
- **Error Handling**: Generic error messages displayed to users to prevent information disclosure
- **No Console Logging**: Authentication errors not logged to console to prevent leak of sensitive data
- **Duplicate Interceptors**: Protected against multiple interceptor registrations
- **Credentials Scope**: `withCredentials: true` only set for `/api/` paths to limit cookie exposure
- **Password Handling**: Passwords cleared from memory after successful login
- **URL Validation**: Strict path checking for API requests to prevent credential leakage to external domains

## API Pagination
- **Collection GET endpoints**: Support `Start` (index) and `Num` (page size) parameters for pagination
- **Default page size**: Always use `Num=100` (maximum result set size)
- **Auto-pagination**: If a response returns exactly `Num` results, automatically fetch next page with `Start = Start + Num` and append results until fewer than `Num` results are returned
- **Pagination Utility**: Use `fetchPaged(fetchFn, pageSize)` from `$lib` for automatic pagination handling

## Application Structure
- **Routes**: SvelteKit file-based routing in `src/routes/`
  - `/` - Home page
  - `/calendar` - Displays all vacancies using `VacancyService.getVacancies()` with auto-pagination
  - `/login` - Login form with email/password fields
- **Layout**: Top-level navigation in `src/routes/+layout.svelte` with Home, Calendar, and Login/Logout links
- **Navigation**: Login/Logout toggle based on `sessionStorage.access_token` presence
- **Shared Utilities**: Place reusable functions in `src/lib/` and export via `src/lib/index.js`

## Verification
- **End-to-End Verification**: Playwright tests in `e2e/` verify UI behavior and API responses.
- **Unit tests**: This project does NOT include unit tests.

## Playwright Testing Principles
- **Environment Variables**: ALWAYS store test credentials and secrets in `.env` file (gitignored), NEVER hardcode in test files. Document the required variables in a `.env.example` file in the project root so new developers know what to configure.
  - Required variables for Playwright tests:
    - `TEST_EMAIL`
    - `TEST_PASSWORD`

  Example `.env.example`:
  ```env
  TEST_EMAIL=your-test-user@example.com
  TEST_PASSWORD=your-secure-test-password
- **Configuration**: Load environment variables in `playwright.config.js` using `dotenv.config()`
- **Test Structure**: Each test should be self-contained and clean up after itself
- **Navigation**: Use `baseURL` in config for cleaner test URLs, navigate with `page.goto('/')`
- **Assertions**: 
  - Use `expect(page).toHaveURL()` for navigation assertions
  - Use `expect(locator).toBeVisible()` for element visibility
  - Use `expect(locator).not.toBeVisible()` for hidden elements
  - Use `page.evaluate()` to access browser storage (sessionStorage, localStorage)
- **Form Interaction**: Use `page.fill()` for inputs and `page.click()` for buttons
- **Selectors**: Prefer semantic selectors (e.g., `nav a[href="/login"]`, `input[name="email"]`)
- **Security**: Never log credentials or tokens in test output
- **Test Flow**: Structure tests to mirror user behavior:
  1. Setup (clear cookies, navigate)
  2. Action (click, fill, submit)
  3. Assertion (verify URL, verify DOM, verify storage)

